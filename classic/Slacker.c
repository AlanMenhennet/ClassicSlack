#include "Slacker.h"#define WINDOW_MARGIN 10#define WINDOW_MENU_HEIGHT 30#define TEXT_AREA_HEIGHT 70#define GUTTER_SIZE 10#define SUBMIT_WIDTH 100#define INPUT_PADDING 2short int quitting = 0;ControlHandle gSubmitButton;TEHandle messageTE;TEHandle inputTE;ControlHandle scrollBar;Rect submitRect;Rect scrollRect;WindowPtr win;int main() {	init();	setUpWindow();	eventLoop();	}void setUpWindow(){		Rect win_bounds = { WINDOW_MARGIN + WINDOW_MENU_HEIGHT, 		WINDOW_MARGIN, 		0, 		0	};	Rect destRect, viewRect, inputRect, bounds;					Str255 title = "\pChat";	Str255 buttonText = "\pButton Text";	short fontNum = 0;		// Create the Window	win_bounds.right = screenBits.bounds.right - WINDOW_MARGIN;	win_bounds.bottom = screenBits.bounds.bottom - WINDOW_MARGIN;	win = NewWindow(0L, &win_bounds, title, true,		documentProc, (WindowPtr)-1L, true, 0);		if(win == nil){		ExitToShell();		}					ShowWindow(win);	SetPort(win);	GetFNum("\pMonaco", &fontNum);	bounds = win->portRect;		/*	 * Create the Text Editor	 */	SetRect(&viewRect,		bounds.left + GUTTER_SIZE, 		bounds.top + GUTTER_SIZE, 		bounds.right - GUTTER_SIZE, 		bounds.bottom - TEXT_AREA_HEIGHT - GUTTER_SIZE	);		SetRect(&destRect, 		bounds.left + GUTTER_SIZE, 		bounds.top + GUTTER_SIZE, 		bounds.right - GUTTER_SIZE,		10000	);		messageTE = TENew(&destRect, &viewRect);	(*messageTE)->txFont = monaco;	(*messageTE)->txSize = 9;			/*	 * Create Scroll Bar	 */	SetRect(&scrollRect, 		bounds.left + GUTTER_SIZE,		bounds.top + GUTTER_SIZE, 		bounds.right - GUTTER_SIZE,		bounds.bottom - GUTTER_SIZE		);			/*	 * Create Text Edit For Input	 */	SetRect(&inputRect,		bounds.left + GUTTER_SIZE, 		bounds.bottom  - TEXT_AREA_HEIGHT, 		bounds.right - GUTTER_SIZE - SUBMIT_WIDTH, 		bounds.bottom - WINDOW_MARGIN	);	SetPort(win);	inputTE = TENew(&inputRect, &inputRect);	if(inputTE == NULL){		SysBeep(10);		ExitToShell();	}	(*inputTE)->txFont = monaco;	(*inputTE)->txSize = 9;	TEAutoView(true, inputTE);	TEActivate(inputTE); 		drawButton(win);}void drawInput(TEHandle input){	Rect frameRect;		TEUpdate(&(*input)->viewRect, input);	frameRect = (*input)->viewRect;	InsetRect(&frameRect, -INPUT_PADDING, -INPUT_PADDING);		FrameRect(&frameRect);}void handleUpdate(EventRecord *event){			WindowPtr win = (WindowPtr) event->message;		BeginUpdate(win);	/*	TEUpdate(&win->portRect, inputTE);	*/			EraseRect(&win->portRect);		drawInput(messageTE);	drawInput(inputTE);		MoveTo(10, 222);	DrawString("\pType your message");				DrawControls(win);		EndUpdate(win);	}void init(){	InitGraf(&thePort);	InitFonts();	FlushEvents(everyEvent, 0);	InitWindows();	InitMenus();	TEInit();	InitDialogs(0);	InitCursor();	MaxApplZone();	}void eventLoop(){	char c;	while(!quitting){		EventRecord event;		WindowPtr event_win;		// This is where the event took place		short event_in;				// Extract when creating mouse handling method		Point mouseLoc;		ControlHandle control;				WaitNextEvent(everyEvent, &event, 10L, 0);		event_in = FindWindow(event.where, &event_win);				switch(event.what){			case mouseDown:				handleMouseDown(event_in, event, event_win);				break;							case keyDown:				handleTEKey(&event);				break;							case updateEvt:				handleUpdate(&event);				break;		}				TEIdle(inputTE);			}}void handleDrag(EventRecord *event){	DragWindow(win, event->where, &screenBits.bounds);	}void handleTEKey(EventRecord *event){	long selStart, selEnd;	char c = event->message & charCodeMask;	TESetSelect( (*inputTE)->selEnd, (*inputTE)->selEnd, inputTE);		if(c == 8 || c == 0x7F){ 		selStart = (*inputTE)->selStart;		selEnd = (*inputTE)->selEnd;				TEDeactivate(inputTE);				if(selStart == selEnd && selStart > 0){			TESetSelect(selStart -1, selStart, inputTE);		}				TEDelete(inputTE);		TEActivate(inputTE);		TESelView(inputTE);	} else {		TEInsert(&c, 1, inputTE);	}			}void handleControlClick(ControlHandle control) {		Handle textHandle;	long textLen;	char newLine = '\r';	char name[] = "Alan>";		if(control == gSubmitButton){		SysBeep(1);				textHandle = (*inputTE)->hText;		textLen = (*inputTE)->teLength;				HLock(textHandle);			TEInsert(name,5, messageTE);		TEInsert(*textHandle,textLen, messageTE);		TEInsert(&newLine,1, messageTE);		HUnlock(textHandle);				/* Clear Input */		TESetText("", 0, inputTE);		InvalRect(&(*inputTE)->viewRect);	}}void handleMouseDown(short event_in, EventRecord event, WindowPtr event_win){	Point mouseLoc;	ControlHandle control;	switch(event_in){		case inSysWindow:			SystemClick(&event, event_win);			break;		case inDrag:			DragWindow(event_win, event.where, &screenBits.bounds);			break;		case inGoAway:			if(TrackGoAway(event_win, event.where)){				quitting = 1;			}			break;				case inContent:			if(event_win != FrontWindow()){				SelectWindow(event_win);			} else {				mouseLoc = event.where;				GlobalToLocal(&mouseLoc);								if(FindControl(mouseLoc, event_win, &control)){					if(TrackControl(control, mouseLoc, nil)){						// Button was clicked						handleControlClick(control);						}				}			}			}}void drawButton(WindowPtr win){	Rect bounds = win->portRect;		Rect buttonPos;	Str255 buttonText = "\pSend";	short textWidth = StringWidth(buttonText);	short textHeight = 20;	buttonPos.top = bounds.bottom - TEXT_AREA_HEIGHT;	buttonPos.left = bounds.right - SUBMIT_WIDTH;	buttonPos.right = bounds.right - WINDOW_MARGIN;	buttonPos.bottom = bounds.bottom - WINDOW_MARGIN;		gSubmitButton = NewControl(win, &buttonPos, buttonText, true,		0,0,1,pushButProc, 0L);}